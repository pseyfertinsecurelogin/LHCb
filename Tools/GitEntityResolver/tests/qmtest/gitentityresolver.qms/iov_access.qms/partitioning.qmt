<?xml version="1.0" ?><!DOCTYPE extension  PUBLIC '-//QM/2.3/Extension//EN'  'http://www.codesourcery.com/qm/dtds/2.3/-//qm/2.3/extension/
/en.dtd'>
<extension class="GaudiTest.GaudiExeTest" kind="test">
<argument name="program"><text>gaudirun.py</text></argument>
<argument name="args"><set>
  <text>-v</text>
  <text>${DETDESCCHECKSROOT}/options/LoadDDDB.py</text>
</set></argument>
<argument name="options"><text>
from Gaudi.Configuration import *
from GitTestOptions import setup
setup(tag='v1', conditions=['/dd/Changing'])

from Configurables import EventClockSvc, FakeEventTime

ecs = EventClockSvc()
ecs.addTool(FakeEventTime, 'EventTimeDecoder')
# tuned from the content of /dd/Changing for tag v1
ecs.EventTimeDecoder.StartTime = 1443744000000000000
ecs.EventTimeDecoder.TimeStep = 15724800000000000

ApplicationMgr(EvtMax=4)

</text></argument>
<argument name="validator"><text>
from subprocess import check_output
import os
import re

tag = 'v1'
repository = os.environ['GIT_TEST_REPOSITORY']
commit_id = check_output(['git', 'rev-parse', tag], cwd=repository)
parameter = 0

countErrorLines()

findReferenceBlock('''
ToolSvc.GitDDDB     DEBUG Initializing...
ToolSvc.GitDDDB     DEBUG opening Git repository '{repository}'
ToolSvc.GitDDDB     DEBUG commit '{tag}' corresponds to {commit_id}
ToolSvc.GitDDDB     DEBUG Successfully initialized.
'''.format(repository=repository, commit_id=commit_id, tag=tag),
id='GitEntityResolver.initialization')

findReferenceBlock('''
LoadDDDB             INFO Database {repository} tag {tag}
'''.format(repository=repository, commit_id=commit_id, tag=tag),
id='reported_tag')

# grep
stripped_output = '\n'.join(l for l in stdout.splitlines()
                            if re.match(r'^---|^Validity|^\(int\) parameter', l))

findReferenceBlock('''
--- /dd/Changing
Validity: 0.0 -> 1451606400.0
(int) parameter = 0
--- /dd/Changing
Validity: 1451606400.0 -> 1467331200.0
(int) parameter = 0
--- /dd/Changing
Validity: 1467331200.0 -> 1483228800.0
(int) parameter = 1
--- /dd/Changing
Validity: 1483228800.0 -> 9223372036.854775807
(int) parameter = 1
''',
stdout=stripped_output,
id='condition_value')

</text></argument>
<argument name="prerequisites"><set>
  <tuple><text>gitentityresolver.prepare</text><enumeral>PASS</enumeral></tuple>
</set></argument>
<argument name="use_temp_dir"><enumeral>true</enumeral></argument>
</extension>
